# üöÄ Guia Completo do Backend Vetra

## üìã √çndice
- [Vis√£o Geral](#-vis√£o-geral)
- [Arquitetura](#-arquitetura)
- [APIs Implementadas](#-apis-implementadas)
- [Banco de Dados](#-banco-de-dados)
- [Servi√ßos](#-servi√ßos)
- [Seguran√ßa](#-seguran√ßa)
- [Fluxos de Dados](#-fluxos-de-dados)

---

## üéØ Vis√£o Geral

O backend do Vetra √© uma **API REST completa** constru√≠da em **Node.js + Express** que:

1. ‚úÖ **Autentica usu√°rios** (Google OAuth + Guest mode)
2. ‚úÖ **Analisa transa√ß√µes Solana** com IA Multi-Agente
3. ‚úÖ **Armazena hist√≥rico** de transa√ß√µes analisadas
4. ‚úÖ **Gerencia attestations** on-chain
5. ‚úÖ **Sistema de reputa√ß√£o** para provedores
6. ‚úÖ **Notifica√ß√µes em tempo real** via WebSocket
7. ‚úÖ **Configura√ß√µes de usu√°rio** personaliz√°veis
8. ‚úÖ **Monitoramento e m√©tricas** completos

---

## üèóÔ∏è Arquitetura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Vetra Backend API                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ  ‚îÇ   Express    ‚îÇ  ‚îÇ  PostgreSQL  ‚îÇ  ‚îÇ    Redis     ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ   (API)      ‚îÇ  ‚îÇ  (Database)  ‚îÇ  ‚îÇ   (Cache)    ‚îÇ     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ  ‚îÇ  Socket.IO   ‚îÇ  ‚îÇ Solana Web3  ‚îÇ  ‚îÇ Multi-Agent  ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ (WebSocket)  ‚îÇ  ‚îÇ (Blockchain) ‚îÇ  ‚îÇ   (AI/ML)    ‚îÇ     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îÇ                                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Stack Tecnol√≥gica

**Core:**
- Node.js 18+
- Express.js 4.18
- PostgreSQL 15
- Redis 7

**Autentica√ß√£o:**
- JWT (jsonwebtoken)
- Passport.js
- Google OAuth 2.0
- bcrypt para hashing

**Blockchain:**
- @solana/web3.js
- @solana/spl-token

**Real-time:**
- Socket.IO 4.7

**Seguran√ßa:**
- Helmet.js
- CORS
- express-rate-limit
- express-validator

**Monitoramento:**
- Winston (logging)
- Morgan (HTTP logs)
- Prometheus (metrics)
- Sentry (error tracking)

---

## üì° APIs Implementadas

### **1. Autentica√ß√£o (`/api/auth/*`)**

#### `POST /api/auth/google`
**Fun√ß√£o:** Inicia login com Google OAuth
**Resposta:**
```json
{
  "success": true,
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "name": "User Name",
    "avatar": "https://...",
    "provider": "google",
    "subscription_plan": "free"
  },
  "accessToken": "jwt-token",
  "refreshToken": "refresh-token"
}
```

#### `POST /api/auth/guest`
**Fun√ß√£o:** Login como visitante (sem registro)
**Body:**
```json
{
  "name": "Guest User" // opcional
}
```

#### `POST /api/auth/refresh`
**Fun√ß√£o:** Renovar access token
**Body:**
```json
{
  "refreshToken": "refresh-token"
}
```

#### `POST /api/auth/logout`
**Fun√ß√£o:** Deslogar usu√°rio
**Headers:** `Authorization: Bearer jwt-token`

#### `GET /api/auth/me`
**Fun√ß√£o:** Obter dados do usu√°rio atual
**Headers:** `Authorization: Bearer jwt-token`

---

### **2. Transa√ß√µes (`/api/transactions/*`)**

#### `POST /api/transactions/analyze` ‚≠ê **PRINCIPAL**
**Fun√ß√£o:** Analisa uma transa√ß√£o Solana usando Multi-Agent System
**Headers:** `Authorization: Bearer jwt-token`
**Body:**
```json
{
  "transactionData": {
    "signature": "optional",
    "type": "transfer|swap|approve|mint|burn|other",
    "from": "wallet-address-from",
    "to": "wallet-address-to",
    "amount": "1.5",
    "token": "token-address" // opcional
  }
}
```

**Resposta:**
```json
{
  "success": true,
  "analysis": {
    "score": 85,
    "level": "high",
    "confidence": 0.92,
    "reasons": [
      "Token created less than 24 hours ago",
      "Low liquidity detected",
      "Destination address flagged"
    ],
    "agent_analysis": {
      "token_agent": {
        "score": 90,
        "findings": [...],
        "severity": "high"
      },
      "address_agent": { ... },
      "pattern_agent": { ... },
      "network_agent": { ... },
      "ml_agent": { ... }
    },
    "recommendations": {
      "action": "block",
      "reason": "Multiple high-severity risk factors detected",
      "alternative_actions": [...]
    },
    "evidence": { ... },
    "metadata": { ... }
  },
  "transaction": {
    "id": "uuid",
    "risk_score": 85,
    "risk_level": "high",
    "status": "pending"
  },
  "cached": false
}
```

**O que faz:**
1. Valida os dados de entrada
2. Verifica cache Redis (se j√° analisou antes)
3. Chama Multi-Agent System API
4. Processa resposta dos agentes
5. Salva no PostgreSQL
6. Armazena em cache (1 hora)
7. Retorna an√°lise completa

#### `GET /api/transactions/history`
**Fun√ß√£o:** Hist√≥rico de transa√ß√µes analisadas
**Query Params:**
- `page` (default: 1)
- `limit` (default: 20, max: 100)
- `status` (pending|approved|rejected|completed)
- `risk_level` (low|medium|high)

**Resposta:**
```json
{
  "success": true,
  "data": {
    "transactions": [...],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 150,
      "pages": 8
    }
  }
}
```

#### `GET /api/transactions/:id`
**Fun√ß√£o:** Detalhes de uma transa√ß√£o espec√≠fica

#### `PATCH /api/transactions/:id/status`
**Fun√ß√£o:** Atualizar status (aprovar/rejeitar)
**Body:**
```json
{
  "status": "approved|rejected",
  "feedback": "optional user feedback"
}
```

#### `GET /api/transactions/stats/risk`
**Fun√ß√£o:** Estat√≠sticas de risco do usu√°rio
**Resposta:**
```json
{
  "success": true,
  "stats": {
    "total_transactions": 150,
    "avg_risk_score": 45.5,
    "high_risk_count": 20,
    "medium_risk_count": 50,
    "low_risk_count": 80,
    "approved_count": 120,
    "rejected_count": 30
  }
}
```

---

### **3. Attestations (`/api/attestations/*`)**

#### `POST /api/attestations`
**Fun√ß√£o:** Criar attestation on-chain
**Body:**
```json
{
  "transactionHash": "transaction-hash",
  "riskScore": 85,
  "riskLevel": "high",
  "stakeAmount": 5.0,
  "evidence": { ... }
}
```

**O que faz:**
1. Verifica se o usu√°rio √© um provider
2. Valida o stake m√≠nimo (1 SOL)
3. Cria attestation na blockchain Solana
4. Salva no PostgreSQL
5. Atualiza estat√≠sticas do provider

#### `GET /api/attestations`
**Fun√ß√£o:** Listar attestations
**Query Params:**
- `page`, `limit`
- `transactionHash`
- `providerPubkey`
- `riskLevel`
- `verified`

#### `GET /api/attestations/:id`
**Fun√ß√£o:** Detalhes de um attestation

#### `POST /api/attestations/:id/vote`
**Fun√ß√£o:** Votar em um attestation
**Body:**
```json
{
  "vote": "approve|reject",
  "stakeAmount": 0.5
}
```

**O que faz:**
1. Provider vota em attestation de outro
2. Aposta SOL no voto
3. Registra on-chain
4. Atualiza verifica√ß√£o (>60% aprova√ß√£o = verificado)

#### `POST /api/attestations/stake`
**Fun√ß√£o:** Fazer stake de reputa√ß√£o
**Body:**
```json
{
  "amount": 10.0
}
```

#### `GET /api/attestations/providers/stats`
**Fun√ß√£o:** Estat√≠sticas de todos os providers
**Resposta:**
```json
{
  "success": true,
  "stats": {
    "total_providers": 50,
    "active_providers": 45,
    "verified_providers": 30,
    "avg_reputation": 650,
    "avg_stake": 500.0,
    "total_stake": 25000.0
  }
}
```

---

### **4. Usu√°rios (`/api/users/*`)**

#### `GET /api/users/profile`
**Fun√ß√£o:** Perfil do usu√°rio

#### `PATCH /api/users/profile`
**Fun√ß√£o:** Atualizar perfil
**Body:**
```json
{
  "name": "New Name",
  "avatar": "https://..."
}
```

#### `GET /api/users/settings`
**Fun√ß√£o:** Configura√ß√µes do usu√°rio

#### `PATCH /api/users/settings`
**Fun√ß√£o:** Atualizar configura√ß√µes
**Body:**
```json
{
  "settings": { ... },
  "preferences": { ... }
}
```

#### `GET /api/users/stats`
**Fun√ß√£o:** Estat√≠sticas completas do usu√°rio
**Resposta:**
```json
{
  "success": true,
  "stats": {
    "transactions": {
      "total_transactions": 150,
      "avg_risk_score": 45.5,
      ...
    },
    "recent_activity": [...],
    "subscription": {
      "plan": "free",
      "expires_at": null,
      "member_since": "2024-01-01"
    }
  }
}
```

#### `DELETE /api/users/account`
**Fun√ß√£o:** Deletar conta permanentemente
**Body:**
```json
{
  "confirmation": "DELETE"
}
```

---

### **5. Configura√ß√µes (`/api/settings/*`)**

#### `GET /api/settings`
**Fun√ß√£o:** Todas as configura√ß√µes

#### `PATCH /api/settings`
**Fun√ß√£o:** Atualizar configura√ß√µes
**Body:**
```json
{
  "theme": "dark|light|auto",
  "language": "en|pt|es",
  "notifications": { ... },
  "risk_threshold": 50,
  "auto_block_high_risk": false,
  "ai_rigidity": 50,
  "ai_language": "en",
  "share_insights": false,
  "transaction_memory": true,
  "smart_contract_fingerprints": true
}
```

#### `POST /api/settings/reset`
**Fun√ß√£o:** Reset para configura√ß√µes padr√£o

#### `GET /api/settings/notifications`
**Fun√ß√£o:** Prefer√™ncias de notifica√ß√µes

#### `PATCH /api/settings/notifications`
**Fun√ß√£o:** Atualizar notifica√ß√µes
**Body:**
```json
{
  "email": true,
  "push": true,
  "risk_alerts": true,
  "attestation_updates": true
}
```

#### `GET /api/settings/languages`
**Fun√ß√£o:** Idiomas dispon√≠veis
**Resposta:**
```json
{
  "success": true,
  "languages": [
    { "code": "en", "name": "English", "native": "English" },
    { "code": "pt", "name": "Portuguese", "native": "Portugu√™s" },
    { "code": "es", "name": "Spanish", "native": "Espa√±ol" }
  ]
}
```

#### `GET /api/settings/themes`
**Fun√ß√£o:** Temas dispon√≠veis

---

### **6. Health & Monitoring (`/api/health/*`)**

#### `GET /api/health`
**Fun√ß√£o:** Health check b√°sico
**Resposta:**
```json
{
  "status": "healthy",
  "timestamp": "2024-01-07T15:30:00Z",
  "uptime": 86400,
  "version": "1.0.0",
  "environment": "production"
}
```

#### `GET /api/health/detailed`
**Fun√ß√£o:** Health check detalhado de todos os servi√ßos
**Resposta:**
```json
{
  "status": "healthy",
  "checks": {
    "api": { "status": "healthy", "responseTime": 5 },
    "database": { "status": "healthy", "responseTime": 12 },
    "redis": { "status": "healthy", "responseTime": 3 },
    "solana": { "status": "healthy", "responseTime": 250 }
  },
  "memory": {
    "used": 150,
    "total": 512,
    "external": 10
  }
}
```

#### `GET /api/health/database`
**Fun√ß√£o:** Status do PostgreSQL

#### `GET /api/health/redis`
**Fun√ß√£o:** Status do Redis

#### `GET /api/health/solana`
**Fun√ß√£o:** Status da conex√£o Solana

#### `GET /api/health/metrics`
**Fun√ß√£o:** M√©tricas gerais do sistema

---

### **7. M√©tricas (`/api/metrics`)**

#### `GET /api/metrics`
**Fun√ß√£o:** M√©tricas Prometheus
**Formato:** Prometheus text format

**M√©tricas inclu√≠das:**
- `http_request_duration_seconds` - Dura√ß√£o de requests
- `http_requests_total` - Total de requests
- `active_connections` - Conex√µes ativas
- `risk_analysis_total` - Total de an√°lises
- `attestations_total` - Total de attestations
- `database_connections` - Conex√µes DB
- `redis_connections` - Conex√µes Redis

---

### **8. WebSocket (`/ws` via Socket.IO)**

#### **Eventos Dispon√≠veis:**

**Client ‚Üí Server:**
- `analyze-transaction` - Solicita an√°lise
- `vote-attestation` - Vota em attestation
- `update-settings` - Atualiza configura√ß√µes
- `subscription-updated` - Atualiza plano

**Server ‚Üí Client:**
- `analysis-started` - An√°lise iniciada
- `analysis-complete` - An√°lise conclu√≠da
- `analysis-error` - Erro na an√°lise
- `vote-confirmed` - Voto confirmado
- `attestation-voted` - Novo voto recebido
- `settings-updated` - Settings atualizados
- `notification` - Notifica√ß√£o geral
- `risk-alert` - Alerta de alto risco
- `attestation-update` - Attestation atualizado

**Exemplo de uso:**
```javascript
const socket = io('wss://api.vetra.com', {
  auth: { token: 'jwt-token' }
});

// Solicitar an√°lise
socket.emit('analyze-transaction', {
  transactionData: { ... }
});

// Receber resultado
socket.on('analysis-complete', (data) => {
  console.log('Risk Score:', data.analysis.score);
});
```

---

## üóÑÔ∏è Banco de Dados

### **PostgreSQL - 4 Tabelas:**

#### **1. users (Usu√°rios)**
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY,
  email VARCHAR UNIQUE NOT NULL,
  name VARCHAR NOT NULL,
  avatar_url VARCHAR,
  provider VARCHAR NOT NULL, -- 'google' | 'guest'
  provider_id VARCHAR,
  is_active BOOLEAN DEFAULT true,
  is_verified BOOLEAN DEFAULT false,
  subscription_plan VARCHAR DEFAULT 'free', -- 'free' | 'pro'
  subscription_expires_at TIMESTAMP,
  preferences JSONB DEFAULT '{}',
  settings JSONB DEFAULT '{}',
  last_login_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**Armazena:**
- Dados de autentica√ß√£o
- Perfil do usu√°rio
- Plano de assinatura
- Prefer√™ncias e configura√ß√µes

#### **2. transactions (Transa√ß√µes)**
```sql
CREATE TABLE transactions (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  signature VARCHAR UNIQUE,
  transaction_hash VARCHAR,
  type VARCHAR NOT NULL, -- 'transfer' | 'swap' | 'approve' | etc
  from_address VARCHAR NOT NULL,
  to_address VARCHAR NOT NULL,
  amount DECIMAL(20,8) NOT NULL,
  token_address VARCHAR,
  token_symbol VARCHAR,
  risk_score INTEGER NOT NULL, -- 0-100
  risk_level VARCHAR NOT NULL, -- 'low' | 'medium' | 'high'
  risk_reasons JSONB DEFAULT '[]',
  heuristics JSONB DEFAULT '{}',
  status VARCHAR DEFAULT 'pending', -- 'pending' | 'approved' | 'rejected'
  user_approved BOOLEAN,
  user_feedback TEXT,
  metadata JSONB DEFAULT '{}',
  analyzed_at TIMESTAMP DEFAULT NOW(),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**Armazena:**
- Hist√≥rico de transa√ß√µes analisadas
- Risk scores e an√°lises
- Feedback do usu√°rio
- Status de aprova√ß√£o/rejei√ß√£o

#### **3. attestations (Atestados)**
```sql
CREATE TABLE attestations (
  id UUID PRIMARY KEY,
  provider_pubkey VARCHAR NOT NULL,
  transaction_hash VARCHAR NOT NULL,
  risk_score INTEGER NOT NULL, -- 0-100
  risk_level VARCHAR NOT NULL,
  stake_amount DECIMAL(20,8) NOT NULL, -- SOL apostado
  reputation INTEGER DEFAULT 0, -- 0-1000
  verified BOOLEAN DEFAULT false,
  evidence JSONB DEFAULT '{}',
  on_chain_signature VARCHAR,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**Armazena:**
- Attestations on-chain
- Stake do provider
- Reputa√ß√£o no momento
- Evid√™ncias coletadas
- Status de verifica√ß√£o

#### **4. providers (Provedores)**
```sql
CREATE TABLE providers (
  id UUID PRIMARY KEY,
  pubkey VARCHAR UNIQUE NOT NULL,
  name VARCHAR,
  description TEXT,
  reputation INTEGER DEFAULT 0, -- 0-1000
  total_stake DECIMAL(20,8) DEFAULT 0,
  attestation_count INTEGER DEFAULT 0,
  successful_attestations INTEGER DEFAULT 0,
  accuracy_rate DECIMAL(5,2) DEFAULT 0, -- 0.00-100.00%
  is_active BOOLEAN DEFAULT true,
  is_verified BOOLEAN DEFAULT false,
  metadata JSONB DEFAULT '{}',
  last_attestation_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**Armazena:**
- Dados dos provedores de attestation
- Reputa√ß√£o acumulada
- Stake total
- Taxa de acerto
- Status de verifica√ß√£o

---

## üîß Servi√ßos

### **1. multiAgentRiskAnalyzer.js** ‚≠ê **PRINCIPAL**

**Fun√ß√£o:** Integra com Sistema Multi-Agente externo

**Entrada:**
```javascript
{
  transaction: {
    signature, type, from_address, to_address,
    amount, token_address, network
  },
  context: {
    user_id, user_reputation, wallet_age_days
  },
  preferences: {
    analysis_depth, include_ml_prediction, language
  }
}
```

**Sa√≠da:**
```javascript
{
  risk_assessment: { score, level, confidence },
  agent_analysis: {
    token_agent: { score, findings, severity },
    address_agent: { score, findings, severity },
    pattern_agent: { score, findings, severity },
    network_agent: { score, findings, severity },
    ml_agent: { score, prediction, confidence }
  },
  risk_factors: [...],
  recommendations: { action, reason, alternatives },
  evidence: { on_chain_data, historical_patterns },
  metadata: { duration, agents_used, timestamp }
}
```

**Funcionalidades:**
- ‚úÖ Cache Redis (evita an√°lises duplicadas)
- ‚úÖ Retry logic (3 tentativas com backoff)
- ‚úÖ Fallback analysis (se Multi-Agent falhar)
- ‚úÖ Health check do Multi-Agent
- ‚úÖ Logging de performance

### **2. attestationService.js**

**Fun√ß√µes:**
- `createAttestation()` - Cria attestation on-chain
- `voteAttestation()` - Vota em attestation
- `stakeReputation()` - Faz stake de SOL
- `withdrawStake()` - Retira stake
- `getAttestationOnChain()` - Busca da blockchain
- `calculateReputation()` - Calcula reputa√ß√£o
- `verifyAttestationAccuracy()` - Verifica precis√£o

### **3. reputationService.js**

**Fun√ß√µes:**
- `updateProviderReputation()` - Atualiza reputa√ß√£o baseado em accuracy
- `calculateProviderReputation()` - Calcula score (0-1000)
- `getProviderLeaderboard()` - Ranking de providers
- `getProviderStats()` - Estat√≠sticas detalhadas
- `updateProviderVerification()` - Atualiza status de verifica√ß√£o
- `calculateStakingRewards()` - Calcula recompensas
- `getReputationHistory()` - Hist√≥rico de reputa√ß√£o

**C√°lculo de Reputa√ß√£o:**
```javascript
Reputa√ß√£o (0-1000) =
  Base (50) +
  Accuracy (0-300) +  // % de attestations corretos
  Stake (0-200) +     // Total de SOL apostado
  Time (0-150) +      // Tempo ativo
  Activity (0-100)    // Attestations recentes
```

### **4. riskAnalyzer.js** (Fallback)

**Fun√ß√£o:** An√°lise b√°sica quando Multi-Agent n√£o est√° dispon√≠vel

**Heur√≠sticas:**
1. Amount analysis (20 pontos)
2. Address reputation (25 pontos)
3. Token analysis (20 pontos)
4. Transaction type (15 pontos)
5. Network analysis (10 pontos)
6. Time patterns (10 pontos)

---

## üîê Seguran√ßa

### **Camadas de Prote√ß√£o:**

#### **1. Autentica√ß√£o**
- ‚úÖ JWT tokens com expira√ß√£o
- ‚úÖ Refresh tokens (30 dias)
- ‚úÖ Google OAuth 2.0 seguro
- ‚úÖ Valida√ß√£o de tokens

#### **2. Rate Limiting**
```javascript
- API geral: 100 req/15min por IP
- Autentica√ß√£o: 5 req/15min por IP
- An√°lise de risco: 10 req/1min por IP
- Attestations: 5 req/1min por IP
- WebSocket: 30 eventos/1min
```

#### **3. Headers de Seguran√ßa (Helmet.js)**
- Content Security Policy (CSP)
- X-Frame-Options: DENY
- X-XSS-Protection
- Strict-Transport-Security (HSTS)
- X-Content-Type-Options: nosniff

#### **4. Input Validation**
- express-validator em todos os endpoints
- Sanitiza√ß√£o de dados
- Type checking
- Length limits

#### **5. CORS**
- Whitelist de origens
- Credentials permitidos
- M√©todos HTTP espec√≠ficos

#### **6. Prote√ß√£o de Dados**
- Senhas hasheadas (bcrypt)
- JWT secrets seguros
- Conex√µes SSL/TLS
- Dados sens√≠veis em .env

---

## üîÑ Fluxos de Dados

### **Fluxo 1: An√°lise de Transa√ß√£o**

```
1. Frontend envia transa√ß√£o
   POST /api/transactions/analyze
   ‚Üì
2. Backend valida dados
   ‚Üì
3. Verifica cache Redis
   ‚îú‚îÄ Se existe ‚Üí retorna cache
   ‚îî‚îÄ Se n√£o existe ‚Üí continua
   ‚Üì
4. Chama Multi-Agent System
   POST http://multi-agent:5000/api/analyze
   ‚Üì
5. Multi-Agent processa:
   ‚îú‚îÄ Token Agent analisa token
   ‚îú‚îÄ Address Agent verifica endere√ßos
   ‚îú‚îÄ Pattern Agent detecta padr√µes
   ‚îú‚îÄ Network Agent checa rede
   ‚îî‚îÄ ML Agent prediz com modelo
   ‚Üì
6. Multi-Agent retorna an√°lise agregada
   ‚Üì
7. Backend salva no PostgreSQL
   ‚Üì
8. Backend armazena em cache Redis (1h)
   ‚Üì
9. Backend retorna para Frontend
   ‚Üì
10. Frontend exibe score e recomenda√ß√µes
```

### **Fluxo 2: Cria√ß√£o de Attestation**

```
1. Provider cria attestation
   POST /api/attestations
   Body: { transactionHash, riskScore, stakeAmount }
   ‚Üì
2. Backend valida provider e stake
   ‚Üì
3. Cria attestation on-chain (Solana)
   - Programa Anchor executa
   - SOL √© transferido para stake
   ‚Üì
4. Backend salva no PostgreSQL
   - Attestation com signature on-chain
   ‚Üì
5. Backend atualiza stats do provider
   - Incrementa attestation_count
   - Atualiza total_stake
   ‚Üì
6. Backend retorna confirma√ß√£o
   ‚Üì
7. Outros providers podem votar
   POST /api/attestations/:id/vote
   ‚Üì
8. Se >60% aprova√ß√£o ‚Üí verified = true
```

### **Fluxo 3: Autentica√ß√£o Google**

```
1. Frontend inicia login
   Redireciona para Google OAuth
   ‚Üì
2. Usu√°rio autentica no Google
   ‚Üì
3. Google redireciona para callback
   GET /api/auth/google/callback
   ‚Üì
4. Backend recebe dados do Google
   - Email, nome, foto
   ‚Üì
5. Backend verifica se usu√°rio existe
   ‚îú‚îÄ Existe ‚Üí atualiza last_login_at
   ‚îî‚îÄ N√£o existe ‚Üí cria novo usu√°rio
   ‚Üì
6. Backend gera JWT tokens
   - Access token (7 dias)
   - Refresh token (30 dias)
   ‚Üì
7. Backend armazena refresh token no Redis
   ‚Üì
8. Backend retorna tokens + dados do usu√°rio
   ‚Üì
9. Frontend armazena tokens
   - Access token para requests
   - Refresh token para renova√ß√£o
```

### **Fluxo 4: WebSocket Real-time**

```
1. Frontend conecta WebSocket
   io('wss://api.vetra.com', { auth: { token: jwt }})
   ‚Üì
2. Backend autentica via JWT
   ‚Üì
3. Backend adiciona usu√°rio a rooms
   - user:${userId}
   - pro-users (se for Pro)
   ‚Üì
4. Eventos em tempo real:
   
   A) An√°lise de transa√ß√£o:
      Frontend: emit('analyze-transaction')
      Backend: processa
      Backend: emit('analysis-complete')
   
   B) Alerta de alto risco:
      Backend detecta risk_score >= 70
      Backend: emit('high-risk-alert') para pro-users
   
   C) Atualiza√ß√£o de attestation:
      Provider cria/vota attestation
      Backend: emit('attestation-update') para todos
   
   D) Mudan√ßa de configura√ß√µes:
      Frontend: emit('update-settings')
      Backend: salva no DB
      Backend: emit('settings-updated')
```

---

## üìä Sistema de Cache (Redis)

### **O que √© cacheado:**

1. **An√°lises de risco** (1 hora)
   ```
   Key: risk:${transactionHash}
   Value: { score, level, reasons, ... }
   ```

2. **Sess√µes de usu√°rio** (24 horas)
   ```
   Key: session:${sessionId}
   Value: { userId, email, ... }
   ```

3. **Refresh tokens** (30 dias)
   ```
   Key: refresh:${userId}
   Value: refresh-token-string
   ```

4. **Rate limiting** (15 minutos)
   ```
   Key: rate_limit:ip:${ipAddress}
   Value: request_count
   ```

5. **Dados de usu√°rio** (1 hora)
   ```
   Key: user:${userId}
   Value: { profile, settings, ... }
   ```

---

## ü§ñ Integra√ß√£o Multi-Agente

### **Como Funciona:**

O backend **N√ÉO faz a an√°lise de risco**, ele **delega** para um sistema externo especializado (Multi-Agent System).

### **Responsabilidades:**

**Backend (Node.js):**
- Recebe transa√ß√£o do frontend
- Valida dados
- Chama Multi-Agent API (HTTP POST)
- Processa resposta
- Salva no banco
- Retorna para frontend

**Multi-Agent System (Python/IA):**
- Analisa token (liquidez, idade, holders)
- Analisa endere√ßos (reputa√ß√£o, hist√≥rico)
- Detecta padr√µes (rug pull, pump&dump)
- Verifica rede (congestionamento, gas)
- Prediz com ML (Random Forest, LSTM)
- Retorna score agregado (0-100)

### **Por que essa separa√ß√£o?**

‚úÖ **Escalabilidade** - Multi-Agent pode rodar em servidores separados
‚úÖ **Especializa√ß√£o** - Python melhor para IA/ML
‚úÖ **Independ√™ncia** - Sistemas podem evoluir separadamente
‚úÖ **Performance** - An√°lise pesada n√£o bloqueia API
‚úÖ **Testabilidade** - Mock server para desenvolvimento

---

## üìà Monitoramento

### **1. Logs (Winston)**

**N√≠veis:**
- `error` - Erros cr√≠ticos
- `warn` - Avisos
- `info` - Informa√ß√µes gerais
- `debug` - Debug detalhado

**Arquivos:**
- `logs/error.log` - Apenas erros
- `logs/combined.log` - Todos os logs
- `logs/access.log` - Logs HTTP

**Logs estruturados:**
```json
{
  "level": "info",
  "message": "Risk Analysis",
  "transactionId": "tx-123",
  "riskScore": 85,
  "riskLevel": "high",
  "timestamp": "2024-01-07T15:30:00Z"
}
```

### **2. M√©tricas (Prometheus)**

**Coletadas automaticamente:**
- Request duration
- Request count por rota
- Active connections
- Database queries
- Cache hit rate
- Error rate

### **3. Error Tracking (Sentry)**

**Configurado para:**
- Capturar exce√ß√µes n√£o tratadas
- Stack traces completos
- Environment context
- User context (quando dispon√≠vel)
- Performance profiling

---

## üê≥ Deploy

### **Docker Compose (Development):**

```yaml
services:
  postgres:  # Banco de dados
  redis:     # Cache
  api:       # Backend API
  nginx:     # Load balancer
```

**Comando:**
```bash
docker-compose up -d
```

### **Docker Compose (Production):**

```yaml
services:
  postgres:  # Com persistent volumes
  redis:     # Com persistent volumes
  api:       # Multi-instance
  nginx:     # Com SSL/TLS
```

**Comando:**
```bash
docker-compose -f docker-compose.prod.yml up -d
```

### **Railway (Cloud):**

- Arquivo `railway.json` configurado
- Nixpacks detecta Node.js automaticamente
- Auto-deploy no git push
- PostgreSQL e Redis inclusos
- HTTPS autom√°tico

---

## üìä Estat√≠sticas do Backend

```
üì¶ Depend√™ncias: 20+ packages
üõ£Ô∏è  Rotas: 30+ endpoints
üóÑÔ∏è  Tabelas: 4 no PostgreSQL
üîß Servi√ßos: 4 principais
üõ°Ô∏è  Middlewares: 10+
üìù Configura√ß√µes: 14 m√≥dulos
üß™ Tests: Configurado (Jest)
üê≥ Docker: Pronto
üìö Docs: Completas
```

---

## üéØ **Resumo: O que o Backend FAZ**

### **Em Termos Simples:**

1. **Recebe requisi√ß√µes** do Chrome Extension
2. **Autentica usu√°rios** com Google ou Guest
3. **Chama Sistema Multi-Agente** para analisar transa√ß√µes
4. **Armazena tudo** em PostgreSQL
5. **Cache inteligente** com Redis
6. **Notifica em tempo real** via WebSocket
7. **Gerencia attestations** on-chain
8. **Calcula reputa√ß√£o** de providers
9. **Monitora tudo** com logs e m√©tricas
10. **Escala facilmente** com Docker

### **Analogia:**

O backend √© como um **coordenador inteligente**:
- Recebe pedidos de an√°lise
- Delega o trabalho pesado (IA) para especialistas
- Armazena hist√≥rico
- Gerencia reputa√ß√£o
- Notifica quando necess√°rio
- Mant√©m tudo seguro e r√°pido

**√â o "c√©rebro organizacional" do Vetra! üß†**
